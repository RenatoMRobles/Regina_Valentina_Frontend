<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regina Valentina | Experta en Mascotas</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a1b9a">
    <meta name="description" content="Regina Valentina: La experta en comportamiento animal.">
    <style>
        @import url('https://fonts.cdnfonts.com/css/open-dyslexic');
        @import url('https://fonts.cdnfonts.com/css/gallaudet');

        body.dyslexia-mode * { font-family: 'OpenDyslexic', sans-serif !important; letter-spacing: 0.05em !important; }
        
        /* ğŸ‘‡ LUPA POTENCIADA (Letra aÃºn mÃ¡s grande) ğŸ‘‡ */
        body.large-text-mode .message { font-size: 1.4rem !important; line-height: 1.6 !important; }
        body.large-text-mode input { font-size: 1.25rem !important; }
        body.large-text-mode .chip { font-size: 1.15rem !important; }

        body.high-contrast-mode { --bg-body: #000 !important; --bg-chat: #000 !important; --text-main: #fff !important; --header-bg: #000 !important; --bot-bubble: #1a1a1a !important; --bot-text: #fff !important; --input-border: #ff0 !important; }
        body.high-contrast-mode .header { border-bottom: 3px solid #ff0; }
        body.high-contrast-mode button, body.high-contrast-mode .chip { border: 2px solid #ff0 !important; color: #ff0 !important; background: #000 !important; }
        body.high-contrast-mode .user-message { background-color: #ff0 !important; color: #000 !important; font-weight: bold; }
        body.lsm-mode .message { font-family: 'Gallaudet', sans-serif !important; font-size: 2.2rem !important; }

        :root { --bg-body: #f4f4f9; --bg-chat: #ffffff; --text-main: #333333; --header-bg: #6a1b9a; --bot-bubble: #f1f0f0; --bot-text: #333333; --input-border: #ddd; }
        [data-theme="dark"] { --bg-body: #121212; --bg-chat: #1e1e1e; --text-main: #e0e0e0; --header-bg: #4a148c; --bot-bubble: #2d2d2d; --bot-text: #e0e0e0; --input-border: #444; }
        [data-theme="sepia"] { --bg-body: #f4ecd8; --bg-chat: #fdf6e3; --text-main: #5b4636; --header-bg: #8b6b61; --bot-bubble: #ede0c8; --bot-text: #4a3b32; --input-border: #d3c4a9; }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-body); color: var(--text-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; flex-direction: column; transition: 0.3s; }
        
        /* ğŸ‘‡ CHAT ENSANCHADO PARA PANTALLAS GRANDES ğŸ‘‡ */
        .chat-container { width: 95%; max-width: 750px; background: var(--bg-chat); border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column; height: 85vh; margin-top: 15px; margin-bottom: 20px; transition: 0.3s; }
        
        .header { background-color: var(--header-bg); color: white; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; }
        .regina-avatar { width: 65px; height: 65px; border-radius: 50%; border: 3px solid white; object-fit: cover;}
        
        /* ğŸ‘‡ LETRA DE CABECERA LIGERAMENTE AUMENTADA ğŸ‘‡ */
        .header h1 { margin: 0; font-size: 1.6em; }
        .header p { margin: 5px 0 0 0; font-size: 1em; opacity: 0.9; }

        .theme-toggle { position: absolute; right: 15px; top: 15px; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.8; transition: 0.3s; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* ğŸ‘‡ MENSAJES MÃS ANCHOS Y LETRA MÃS GRANDE ğŸ‘‡ */
        .message { max-width: 85%; padding: 12px 18px; border-radius: 20px; font-size: 1.05rem; line-height: 1.5; position: relative; word-wrap: break-word; white-space: pre-wrap; }
        .user-message { align-self: flex-end; background-color: #6a1b9a; color: white; border-bottom-right-radius: 2px; }
        .bot-message { align-self: flex-start; background-color: var(--bot-bubble); color: var(--bot-text); border-bottom-left-radius: 2px; }
        
        .input-area { padding: 20px; border-top: 1px solid var(--input-border); display: flex; gap: 10px; background: var(--bg-chat); }
        .input-area input { font-size: 1.05rem; flex: 1; padding: 10px; background: var(--bg-body); color: var(--text-main); border: 1px solid var(--input-border); border-radius: 20px; outline: none; }
        .input-area button { font-size: 1.05rem; padding: 10px 20px; background-color: #6a1b9a; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        
        /* ğŸ‘‡ CHIPS DE PREGUNTAS CON LETRA MÃS GRANDE ğŸ‘‡ */
        .chips-container { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; background: var(--bg-chat); }
        .chip { background-color: var(--bg-body); border: 2px solid #6a1b9a; color: var(--text-main); padding: 8px 15px; border-radius: 20px; font-size: 0.95rem; font-weight: bold; cursor: pointer; }
        
        .pdf-btn { display: block; margin-top: 10px; background: #e91e63; color: white; text-align: center; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; text-decoration: none; cursor: pointer; width: fit-content; }
        .loading { font-style: italic; color: #888; font-size: 0.9rem; margin-left: 20px; margin-bottom: 10px; display: none; }
        .footer { text-align: center; font-size: 0.85rem; color: #777; padding: 20px; width: 100%; max-width: 700px; }
    </style>
</head>
<body>

<div id="auth-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; display:none;">
    <div style="background:white; padding:40px; border-radius:15px; width:85%; max-width:320px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position:relative;">
        <button onclick="document.getElementById('auth-modal').style.display='none'" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.8em; color:#999; cursor:pointer;">Ã—</button>
        <h2 id="auth-title" style="color:#6a1b9a; margin-top:0;">Acceso VIP ğŸ¤ </h2>
        <div id="auth-inputs">
            <input type="email" id="auth-email" placeholder="Correo" style="width:90%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
            <input type="password" id="auth-password" placeholder="ContraseÃ±a" style="width:90%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="ejecutarLogin()" style="width:90%; padding:12px; background-color:#6a1b9a; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:10px;">Entrar</button>
            <button onclick="ejecutarRegistro()" style="width:90%; padding:12px; background-color:#fff; color:#6a1b9a; border:2px solid #6a1b9a; border-radius:8px; font-weight:bold; cursor:pointer;">Crear Cuenta</button>
        </div>
        <div id="logged-in-view" style="display:none;">
            <button id="btn-centro-mando" onclick="window.open('https://RenatoRobles.pythonanywhere.com/panel-robles?admin_id=' + getUserId(), '_blank')" style="display:none; width:90%; padding:12px; background-color:#1e1e1e; color:#ffca28; border:2px solid #ffca28; border-radius:8px; font-weight:bold; cursor:pointer; margin: 0 auto 15px auto;">ğŸ¦… Centro de Mando</button>
            <button onclick="cerrarSesion()" style="width:90%; padding:12px; background-color:#f44336; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin: 0 auto;">Cerrar SesiÃ³n ğŸšª</button>
        </div>
        <p id="auth-error" style="color:red; font-size:0.85rem; margin-top:15px;"></p>
    </div>
</div>

<div id="trofeo-badge" style="position:fixed; top:20px; right:20px; z-index:9999; background:linear-gradient(145deg, #fff8e1, #ffecb3); border:2px solid #ffca28; padding:8px 15px; border-radius:25px; box-shadow:0 4px 10px rgba(0,0,0,0.2); font-size:1.3em; display:none; align-items:center; gap:5px; font-weight:bold; color:#333; pointer-events:none;">
    ğŸŒŸ <span id="trofeo-count">0</span>
</div>

<div class="chat-container">
   <div class="header">
        <img src="ReginaValentinaRostro.png?v=2" alt="Regina" class="regina-avatar">
        <div>
            <h1>Regina Valentina ğŸ¤ ğŸ¾</h1>
            <p>Experta en Comportamiento</p>
            <div style="display: flex; gap: 12px; margin-top:10px;">
                <button id="btn-header-voice" style="background:rgba(255,255,255,0.2); border-radius:50%; width:38px; height:38px; border:none; color:#ffeb3b; cursor:pointer;" onclick="togglePremiumVoice()">ğŸ’ğŸ—£ï¸</button>
                <button style="background:rgba(255,255,255,0.2); border-radius:50%; width:38px; height:38px; border:none; cursor:pointer;" onclick="toggleTheme()">ğŸŒ™</button>
                <button style="background:rgba(255,255,255,0.2); border-radius:50%; width:38px; height:38px; border:none; cursor:pointer;" onclick="abrirMiCuenta()">ğŸ‘¤</button>
                <button style="background:rgba(255,255,255,0.2); border-radius:50%; width:38px; height:38px; border:none; cursor:pointer;" onclick="document.getElementById('settings-modal').style.display='flex'">âš™ï¸</button>
            </div>
        </div>
    </div>
    
    <div id="chat-box">
        <div class="message bot-message">Â¡Hola! Soy Regina Valentina. CuÃ©ntame, Â¿quÃ© problema traes con tu mascota?</div>
    </div>
    <div class="loading" id="loading">Regina estÃ¡ escribiendo...</div>

    <div class="chips-container">
        <button class="chip" onclick="sendChip('ğŸ¤  Â¿CÃ³mo educar a un perro latoso?')">ğŸ¤  Educar perro latoso</button>
        <button class="chip" onclick="sendChip('ğŸ§ Â¡AnalÃ­zame Regina!')">ğŸ§ AnalÃ­zame</button>
        <button class="chip" onclick="sendChip('ğŸ  Â¿CÃ³mo evitar que se orine adentro?')">ğŸ  PipÃ­ en casa</button>
        <button class="chip" onclick="dispararEmergencia()" style="border-color:#d32f2f; color:#d32f2f;">ğŸ§‘â€âš•ï¸ Urgencia</button>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Escribe tu consulta aquÃ­...">
        <button id="mic-toggle" onclick="toggleMic()" style="background:none; border:none; font-size:1.5em; padding:0; margin-top:-5px;">ğŸ¤</button>
        <input type="file" id="input-foto-chat" accept="image/*" style="display:none;" onchange="previsualizarFotoChat()">
        <button id="btn-camara" onclick="document.getElementById('input-foto-chat').click()" style="background:none; border:none; font-size:1.5em; padding:0; margin-top:-5px;">ğŸ“·</button>
        <button onclick="sendMessage()">Enviar</button>
    </div>
</div> 

<script>
    const API_URL = 'https://RenatoRobles.pythonanywhere.com';
    let voiceEnabled = false;
    let premiumVoiceEnabled = true; 
    let reginaVoice = null;
    let audioPremiumActual = null;
    let dyslexiaEnabled = false;
    let lsmEnabled = false;

    // --- CORTADOR DE AVISO LEGAL (EL SILENCIADOR) ---
    function silenciarAviso(texto) {
        if(texto.includes("Aviso:")) { return texto.split("Aviso:")[0]; }
        return texto;
    }

    function quitarAcentos(texto) { return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
    
    function copiarConsejo(msgId) {
        let clon = document.getElementById(msgId).cloneNode(true);
        clon.querySelectorAll('button, div').forEach(b => b.remove()); 
        navigator.clipboard.writeText(clon.innerText.trim());
        mostrarNotificacion("ğŸ“‹ Copiado al portapapeles"); 
    }
    
    let ultimoMensajeLeido = null;
    function reproducirMensaje(msgId) {
        if (audioPremiumActual) audioPremiumActual.pause();
        if (window.speechSynthesis.speaking && ultimoMensajeLeido === msgId) {
            window.speechSynthesis.cancel();
            ultimoMensajeLeido = null;
            return;
        }
        window.speechSynthesis.cancel();
        ultimoMensajeLeido = msgId;

        const elemento = document.getElementById(msgId);
        let textoPuro = elemento.getAttribute('data-puretext') || elemento.innerText;
        
        textoPuro = silenciarAviso(textoPuro); // APLICAMOS SILENCIADOR
        let textoLimpio = textoPuro.replace(/[\u{1F600}-\u{1F6FF}]/gu, '').replace(/[*_]/g, ''); 
        
        const utterance = new SpeechSynthesisUtterance(textoLimpio);
        if (reginaVoice) utterance.voice = reginaVoice;
        utterance.lang = 'es-MX'; utterance.rate = 1.05; 
        
        utterance.onend = () => { if(ultimoMensajeLeido === msgId) ultimoMensajeLeido = null; };
        window.speechSynthesis.speak(utterance);
    }
    
    function mostrarNotificacion(texto, color = "#6a1b9a", tiempo = 4000) {
        const noti = document.createElement('div');
        noti.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); background:${color}; color:white; padding:12px 24px; border-radius:30px; z-index:9999; font-weight:bold; transition:0.5s; text-align:center;`;
        noti.innerHTML = texto; document.body.appendChild(noti);
        setTimeout(() => { noti.style.opacity = '0'; setTimeout(() => noti.remove(), 500); }, tiempo);
    }

    function hablar(texto) {
        if (!voiceEnabled) return;
        window.speechSynthesis.cancel(); 
        
        let textoALeer = silenciarAviso(texto); // APLICAMOS SILENCIADOR
        let textoLimpio = textoALeer.replace(/[\u{1F600}-\u{1F6FF}]/gu, '').replace(/[*_]/g, ''); 
        
        const utterance = new SpeechSynthesisUtterance(textoLimpio);
        if (reginaVoice) utterance.voice = reginaVoice;
        utterance.lang = 'es-MX'; utterance.rate = 1.05; 
        window.speechSynthesis.speak(utterance);
    }

    function typeEffect(element, text, speed = 18) {
        let i = 0; element.innerHTML = "";
        element.setAttribute('data-original', text); 
        element.setAttribute('data-puretext', text); 
        const msgId = 'msg_' + Date.now(); element.id = msgId;

        let textoAEscribir = lsmEnabled ? quitarAcentos(text) : text;
        hablar(text); 

        function typing() {
            if (i < textoAEscribir.length) {
                element.innerHTML += textoAEscribir.charAt(i); i++;
                setTimeout(typing, speed);
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
            } else {
                let btns = `<br><div style="margin-top:10px; display:flex; flex-wrap:wrap;"><button onclick="copiarConsejo('${msgId}')" style="background:none; border:1px solid #d81b60; color:#d81b60; border-radius:15px; padding:5px 12px; font-weight:bold;">ğŸ“‹ Copiar</button><button onclick="reproducirMensaje('${msgId}')" style="background:none; border:1px solid #2196f3; color:#2196f3; border-radius:15px; padding:5px 12px; margin-left:8px; font-weight:bold;">ğŸ”Š Escuchar</button></div>`;
                element.innerHTML += btns;
                element.setAttribute('data-original', text + btns);
            }
        }
        typing();
    }
    
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const message = input.value;
        const chatBox = document.getElementById('chat-box');
        const loading = document.getElementById('loading');

        if (!message) return;

        chatBox.innerHTML += `<div class="message user-message">${message}</div>`;
        input.value = ''; loading.style.display = 'block';
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const res = await fetch(`${API_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: message, user_id: getUserId(), premium_voice: premiumVoiceEnabled }) });
            const data = await res.json();
            loading.style.display = 'none';

            if (data.response) {
                const newMsg = document.createElement("div"); newMsg.className = "message bot-message";
                chatBox.appendChild(newMsg); typeEffect(newMsg, data.response); 
                if (data.audio) {
                    if (audioPremiumActual) audioPremiumActual.pause();
                    audioPremiumActual = new Audio("data:audio/mp3;base64," + data.audio);
                    audioPremiumActual.play();
                }
                if (data.insignias > 0) {
                    document.getElementById('trofeo-badge').style.display = 'flex';
                    document.getElementById('trofeo-count').innerText = data.insignias;
                    localStorage.setItem('regina_estrellas', data.insignias);
                }
            }
        } catch (e) { loading.style.display = 'none'; }
    }

    document.getElementById("user-input").addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
    function sendChip(texto) { document.getElementById('user-input').value = texto; sendMessage(); }
    
    function getUserId() { 
        let id = localStorage.getItem('regina_user_id');
        if(!id) { id = 'user_' + Math.floor(Math.random() * 10000000); localStorage.setItem('regina_user_id', id); }
        return id;
    }

    window.addEventListener('DOMContentLoaded', () => {
        const medallasGuardadas = localStorage.getItem('regina_estrellas');
        if (medallasGuardadas && medallasGuardadas > 0) {
            document.getElementById('trofeo-badge').style.display = 'flex';
            document.getElementById('trofeo-count').innerText = medallasGuardadas;
        }
        cargarVoces();
    });

    // Accesibilidad BÃ¡sica
    function toggleLupa() { document.body.classList.toggle('large-text-mode'); }
    function toggleContraste() { document.body.classList.toggle('high-contrast-mode'); }
    function toggleDyslexia() { document.body.classList.toggle('dyslexia-mode'); }
    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function togglePremiumVoice() { premiumVoiceEnabled = !premiumVoiceEnabled; mostrarNotificacion(premiumVoiceEnabled ? "Voz HD Activada" : "Voz Silenciada"); if(audioPremiumActual) audioPremiumActual.pause();}
    function abrirMiCuenta() { document.getElementById('auth-modal').style.display = 'flex'; }
</script>

<div id="settings-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; display:none;">
    <div style="background:white; padding:30px; border-radius:15px; width:85%; max-width:320px; text-align:center; position:relative; border-top: 6px solid #6a1b9a;">
        <button onclick="document.getElementById('settings-modal').style.display='none'" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:2em; color:#999; cursor:pointer;">Ã—</button>
        
        <h3 style="color:#6a1b9a; margin-top:30px; margin-bottom:5px;">âš™ï¸ Herramientas</h3>
        <p style="color:#555; font-size:0.9em; margin-bottom:20px;">Ajusta tu experiencia.</p>
        
        <button onclick="alert('Descarga en desarrollo')" style="width:100%; background:#4caf50; color:white; font-weight:bold; font-size:1.1em; padding:12px; border-radius:8px; border:none; margin-bottom:15px;">ğŸ’¾ Guardar Chat (TXT)</button>
        <button onclick="toggleLupa()" style="width:100%; background:#f4f4f9; border:2px solid #ddd; padding:12px; border-radius:10px; margin-bottom:10px; font-weight:bold;">ğŸ” Agrandar Letra</button>
        <button onclick="toggleContraste()" style="width:100%; background:#f4f4f9; border:2px solid #ddd; padding:12px; border-radius:10px; margin-bottom:10px; font-weight:bold;">ğŸŒ— Alto Contraste</button>
        <button onclick="toggleDyslexia()" style="width:100%; background:#f4f4f9; border:2px solid #ddd; padding:12px; border-radius:10px; font-weight:bold;">ğŸ‘“ Dislexia</button>
    </div>
</div>

</body> 
</html>